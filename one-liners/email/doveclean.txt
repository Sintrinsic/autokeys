fails=$(tail -n 10000 /var/log/maillog | grep "auth failed" | gawk -F"[<>,=]" '{print $9, $4}'); echo "$fails" | cut -d" " -f1 |sort |uniq -c | sort -n| awk '$1>7{print $2}' | while read line; do fwr=$(iptables -nL | grep $line | wc -l); wio=$(whois $line | grep -iP "(microsoft|google|websitewelcome|cloudflare)"| wc -l); ttl=$(( $wio + $fwr )); [[ $ttl -lt 1 ]] && (iptables -I INPUT -j DROP -m comment --comment "Dovecot brutes. Remove if a customer complains.  -bdupree $(date +%D)" -s $line; echo "$line dropped.") || echo "Not nuking $line. It's a friendly ip."; done; ps fauxww | grep "checkpassword-reply" | awk '{print $2}' | while read line; do kill $line; done 