function safe_drop_ips { message=$1; shift; ips_to_block=$@; today=$(date +%D); local_ips=$(\hostname -I); for ip in $ips_to_block; do ip_to_drop=$(echo $ip | grep -vf <(echo $local_ips | tr " " "\n") | grep -v 127.0.0.1); if [[ $ip_to_drop =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9\/]{1,4}$ ]]; then iptables -I INPUT -s $ip_to_drop -m comment --comment "bdupree - $today : $message" -j DROP; elif [[ -z $ip_to_drop ]]; then echo "$ip is configured on the server and traffic will not be dropped"; else echo "$ip does not appear to be in the correct format"; fi ; done; echo "Similar iptables rules";  iptables -nvL | grep bdupree | grep "$message" | tac; }; le_triggered=50; bad_ips=$(grep -B5000 -A100000000 -P "^\[$(date +"%a %b %d %H:" -d 'now-1hour').*ModSecurity: Access denied" /usr/local/apache/logs/error_log |grep -P 'wp-login|xmlrpc|administrator'|grep -Po '(?<=client )[^\]]+'|sort|uniq -c|sort -n| grep -v denied | awk -v ORS=' ' "\$1>${le_triggered} { print \$2 }");safe_drop_ips "brute force attempts" $bad_ips 