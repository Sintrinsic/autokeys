rcount=10; unswap(){ (awk -F'[ \t-]+' '/^[a-f0-9]*-[a-f0-9]* /{recent="0x"$1" 0x"$2}/Swap:/&&$2>10000{print recent}' /proc/$1/smaps | while read astart aend; do gdb --batch --pid $1 -ex "dump memory /dev/null $astart $aend" &>/dev/null; done&)2>/dev/null;}; freeswap=$(free -m | awk '/Swap/{print $4}'); while [[ $freeswap -lt 3000 || $rcount -gt 0 ]]; do rcount=$(ps fauxww | grep "dump memory" | grep -v grep | wc -l); freeswap=$(free -m | awk '/Swap/{print $4}'); echo "$rcount        $freeswap"; if [[ $rcount -lt 5 && $freeswap -lt 3000 ]]; then grep VmSwap /proc/*/status 2>/dev/null | awk -F'[/ \t]+' '$5>100{print $3,$5}' | sort -rnk2 | head -n 20 | cut -d" " -f1 | while read line; do unswap $line; done; echo "Spawning new dumps" ;fi;rcount=$(ps fauxww | grep "dump memory" | grep -v grep | wc -l);sleep 1; done
