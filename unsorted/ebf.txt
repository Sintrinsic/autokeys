function safe_drop_ips { message=$1; shift; ips_to_block=$@; today=$(date +%D); local_ips=$(\hostname -I); for ip in $ips_to_block; do ip_to_drop=$(echo $ip | grep -vf <(echo $local_ips | tr " " "\n") | grep -v 127.0.0.1); if [[ $ip_to_drop =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9\/]{1,4}$ ]]; then iptables -I INPUT -s $ip_to_drop -m comment --comment "bdupree - $today : $message" -j DROP; elif [[ -z $ip_to_drop ]]; then echo "$ip is configured on the server and traffic will not be dropped"; else echo "$ip does not appear to be in the correct format"; fi ; done; echo "Similar iptables rules";  iptables -nvL | grep bdupree | grep "$message" | tac; }; attackers 25 2>/dev/null | awk '/^\t/{print $2}' | while read line; do echo $line"--------"; [[ $(grep $line /var/log/exim_mainlog | grep -i "Host is banned" | head -n 1 | wc -l) -gt 0 ]] && safe_drop_ips $line; done ; service dovecot stop && (service dovecot start || ( rm -f /var/run/dovecot/auth-{login,client,userdb,master} && service dovecot start)); service exim restart