function getDomIP() { grep -C5 $1 /usr/local/apache/conf/httpd.conf | grep -oP "(?<=<VirtualHost ).*(?=:80>)" | sort -u | head -n1 ;}; bambeast(){ second=""; [[ $1 ]] && second="-2 $1"; badDom=$(ngrep -q '(POST|GET)' -d any -W byline -n 500 dst port 80|grep Host:|sort|uniq -c|sort -nk1|tail -n1 |awk '{print $NF}' | sed 's/\.$//'); badDomIP=$(getDomIP $badDom); bamLine=$(echo bam.sh -d $badDomIP -s $badDom -p 8080 $second -ef); echo $bamLine; $($bamLine);echo "Rules set. Watching badlist:"; for i in $(seq 1 6); do ipset list | awk '/bam_blacklist/{start=1}/^$/{start=0} $1~/^[0-9\.]*$/&&start==1{print $1}' | wc -l; sleep 10; done }; bambeast 